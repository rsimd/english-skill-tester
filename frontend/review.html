<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>セッションレビュー - English Skill Tester</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div id="review-app">
        <header>
            <h1>セッションレビュー</h1>
            <a href="/" class="btn btn-secondary">ホームへ戻る</a>
        </header>

        <main>
            <!-- Session selector -->
            <div id="session-selector">
                <h2>過去のセッション</h2>
                <div id="session-list" class="session-list">
                    <p class="loading">セッション読み込み中...</p>
                </div>
            </div>

            <!-- Session detail -->
            <div id="session-detail" class="hidden">
                <div class="review-header">
                    <h2>セッション: <span id="review-session-id"></span></h2>
                    <div class="review-meta">
                        <span>日付: <strong id="review-date"></strong></span>
                        <span>レベル: <strong id="review-level"></strong></span>
                        <span>発話数: <strong id="review-utterance-count"></strong></span>
                    </div>
                </div>

                <!-- Transcript with highlights -->
                <div class="review-section">
                    <h3>会話記録</h3>
                    <div id="review-transcript" class="transcript-area"></div>
                </div>

                <!-- Recordings -->
                <div class="review-section" id="review-recordings-section">
                    <h3>録音</h3>
                    <audio id="review-audio" controls></audio>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Review page logic
        async function loadSessions() {
            const res = await fetch('/api/sessions');
            const sessions = await res.json();
            const list = document.getElementById('session-list');

            if (sessions.length === 0) {
                list.innerHTML = '<p>セッションが見つかりません。まず会話を完了してください。</p>';
                return;
            }

            list.innerHTML = '';
            sessions.forEach(s => {
                const card = document.createElement('div');
                card.className = 'session-card';
                card.addEventListener('click', () => loadSession(s.session_id));

                const header = document.createElement('div');
                header.className = 'session-card-header';

                const dateSpan = document.createElement('span');
                dateSpan.className = 'session-date';
                dateSpan.textContent = new Date(s.started_at).toLocaleString();

                const levelSpan = document.createElement('span');
                levelSpan.className = 'session-level badge';
                levelSpan.textContent = s.current_level;

                header.appendChild(dateSpan);
                header.appendChild(levelSpan);

                const body = document.createElement('div');
                body.className = 'session-card-body';

                const utteranceSpan = document.createElement('span');
                utteranceSpan.textContent = s.utterance_count + ' 件の発話';

                const statusSpan = document.createElement('span');
                statusSpan.className = 'session-status';
                statusSpan.textContent = s.status;

                body.appendChild(utteranceSpan);
                body.appendChild(statusSpan);

                card.appendChild(header);
                card.appendChild(body);
                list.appendChild(card);
            });
        }

        async function loadSession(sessionId) {
            const res = await fetch(`/api/sessions/${sessionId}`);
            const session = await res.json();

            document.getElementById('session-detail').classList.remove('hidden');
            document.getElementById('review-session-id').textContent = sessionId.substring(0, 8);
            document.getElementById('review-date').textContent = new Date(session.started_at).toLocaleString();
            document.getElementById('review-level').textContent = session.current_level;
            document.getElementById('review-utterance-count').textContent = session.utterances.length;

            // Render transcript
            const transcriptEl = document.getElementById('review-transcript');
            transcriptEl.innerHTML = '';
            session.utterances.forEach(u => {
                const entry = document.createElement('div');
                entry.className = 'transcript-entry ' + (u.role === 'user' ? 'user' : 'assistant');

                const speaker = document.createElement('span');
                speaker.className = 'speaker';
                speaker.textContent = (u.role === 'user' ? 'あなた' : 'AI') + ':';

                const text = document.createElement('span');
                text.className = 'text';
                text.textContent = u.text;

                entry.appendChild(speaker);
                entry.appendChild(text);
                transcriptEl.appendChild(entry);
            });

            // Audio playback
            if (session.recording_path) {
                document.getElementById('review-recordings-section').classList.remove('hidden');
            } else {
                document.getElementById('review-recordings-section').classList.add('hidden');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadSessions();
    </script>
</body>
</html>
