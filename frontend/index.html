<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Skill Tester</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header id="header">
            <h1>English Skill Tester</h1>
            <div id="connection-status" class="status-indicator disconnected">
                <span class="dot"></span>
                <span class="label">æœªæ¥ç¶š</span>
            </div>
        </header>

        <!-- Main content -->
        <main>
            <!-- 3D Character area -->
            <div id="character-container">
                <canvas id="character-canvas"></canvas>
                <div id="character-fallback" class="character-fallback">
                    <div class="avatar" id="avatar-face">ğŸ¤–</div>
                    <div class="expression-label" id="expression-label">neutral</div>
                </div>
                <div id="model-controls">
                    <button id="btn-change-model" class="btn btn-small" title="VRMãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´">
                        ğŸ”„ ãƒ¢ãƒ‡ãƒ«å¤‰æ›´
                    </button>
                    <input type="file" id="vrm-upload" accept=".vrm" hidden>
                    <span id="model-name" class="model-name-label">default</span>
                </div>
            </div>

            <!-- Score panel -->
            <div id="score-panel">
                <div class="score-header">
                    <div class="overall-score">
                        <span class="score-value" id="overall-score">--</span>
                        <span class="score-label">/ 100</span>
                    </div>
                    <div class="level-badge" id="level-badge">--</div>
                </div>
                <div class="score-estimates">
                    <span class="estimate">TOEIC: <strong id="toeic-estimate">--</strong></span>
                    <span class="estimate">IELTS: <strong id="ielts-estimate">--</strong></span>
                </div>
                <div class="score-bars">
                    <div class="score-bar-item">
                        <label>èªå½™åŠ›</label>
                        <div class="bar-container">
                            <div class="bar" id="bar-vocabulary" style="width: 50%"></div>
                        </div>
                        <span class="bar-value" id="val-vocabulary">50</span>
                    </div>
                    <div class="score-bar-item">
                        <label>æ–‡æ³•åŠ›</label>
                        <div class="bar-container">
                            <div class="bar" id="bar-grammar" style="width: 50%"></div>
                        </div>
                        <span class="bar-value" id="val-grammar">50</span>
                    </div>
                    <div class="score-bar-item">
                        <label>æµæš¢æ€§</label>
                        <div class="bar-container">
                            <div class="bar" id="bar-fluency" style="width: 50%"></div>
                        </div>
                        <span class="bar-value" id="val-fluency">50</span>
                    </div>
                    <div class="score-bar-item">
                        <label>ç†è§£åŠ›</label>
                        <div class="bar-container">
                            <div class="bar" id="bar-comprehension" style="width: 50%"></div>
                        </div>
                        <span class="bar-value" id="val-comprehension">50</span>
                    </div>
                    <div class="score-bar-item">
                        <label>ä¸€è²«æ€§</label>
                        <div class="bar-container">
                            <div class="bar" id="bar-coherence" style="width: 50%"></div>
                        </div>
                        <span class="bar-value" id="val-coherence">50</span>
                    </div>
                </div>
            </div>

            <!-- Transcript -->
            <div id="transcript-panel">
                <h2>ä¼šè©±è¨˜éŒ²</h2>
                <div id="transcript" class="transcript-area"></div>
            </div>
        </main>

        <!-- Controls -->
        <footer id="controls">
            <div id="device-selector" style="margin: 8px 0;">
                <label for="input-device">ãƒã‚¤ã‚¯:</label>
                <select id="input-device">
                    <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                </select>
                <label for="output-device" style="margin-left: 8px;">ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼:</label>
                <select id="output-device">
                    <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                </select>
            </div>
            <!-- ãƒ¬ãƒ™ãƒ«é¸æŠï¼ˆbtn-startã®ä¸Šã‚ãŸã‚Šã«è¿½åŠ ï¼‰ -->
            <div id="level-selector" style="margin-bottom: 12px;">
              <label for="self-reported-level" style="display:block; margin-bottom:4px; font-size:0.9em; color:#666;">
                ã‚ãªãŸã®è‹±èªãƒ¬ãƒ™ãƒ«:
              </label>
              <select id="self-reported-level" style="width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:0.9em;">
                <option value="">è‡ªå‹•åˆ¤å®š</option>
                <option value="A1">A1 (åˆå¿ƒè€…)</option>
                <option value="A2">A2 (åˆç´š)</option>
                <option value="B1">B1 (ä¸­ç´š)</option>
                <option value="B2">B2 (ä¸­ä¸Šç´š)</option>
                <option value="C1">C1 (ä¸Šç´š)</option>
              </select>
            </div>
            <button id="btn-start" class="btn btn-primary">ä¼šè©±ã‚’é–‹å§‹</button>
            <button id="btn-stop" class="btn btn-danger" disabled>åœæ­¢</button>
            <span id="timer" class="timer">00:00</span>
            <div id="loading-indicator" style="display:none; align-items:center; gap:8px; font-size:14px; color:#555;">
                <div class="spinner"></div>
                <span>æ¥ç¶šä¸­...</span>
            </div>
        </footer>

        <!-- Force stop button (fixed top-right, visible during session) -->
        <button id="force-stop-btn"
                style="position:fixed; top:16px; right:16px; z-index:9999;
                       background:#dc3545; color:white; border:none; border-radius:8px;
                       padding:10px 20px; font-size:16px; cursor:pointer; display:none;">
          â¹ çµ‚äº†
        </button>

        <!-- Feedback overlay -->
        <div id="feedback-overlay" class="overlay hidden">
            <div class="overlay-content">
                <h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†</h2>
                <div id="feedback-content"></div>
                <button id="btn-close-feedback" class="btn btn-primary">é–‰ã˜ã‚‹</button>
                <a id="btn-review" class="btn btn-secondary" href="/review.html" style="display:none">
                    è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </a>
            </div>
        </div>
    </div>

    <!-- three.js and VRM loader (CDN) -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
            "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.3.3/lib/three-vrm.module.min.js"
        }
    }
    </script>

    <script src="/js/websocket.js"></script>
    <script src="/js/ui.js"></script>
    <script type="module" src="/js/character.js"></script>
    <script src="/js/app.js"></script>
</body>
</html>
